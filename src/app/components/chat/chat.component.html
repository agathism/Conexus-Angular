<div class="px-4 md:px-8 md:flex md:flex-row md:h-screen md:gap-6">
  <!-- Panneau de gauche - Liste des conversations -->
  <div class="md:w-sm md:flex-shrink-0 flex flex-col my-10 px-4">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Mes discussions</h1>
    </div>

    <div class="rounded-xl divide-y divide-gray-200 md:max-h-[calc(100vh-200px)] md:overflow-y-auto">
      <!-- Section conversation -->
      @for (conversation of conversations; track trackByConversationId($index, conversation)) {
        @if (conversation && conversation.otherUser) {
          <div 
            class="p-4 hover:bg-gray-50 cursor-pointer transition-colors my-1 border-l-4 border-transparent"
            [class.bg-blue-50]="selectedConversation?.otherUser?.id === conversation.otherUser.id"
            [class.border-conexus-green]="selectedConversation?.otherUser?.id === conversation.otherUser.id"
            [class.bg-[#f6f6f6]]="selectedConversation?.otherUser?.id !== conversation.otherUser.id"
            (click)="selectConversation(conversation)"
          >
            <div class="flex items-center">
              <!-- Avatar -->
              <div class="relative">
                <img
                  [src]="conversation.otherUser.profilePicture || 'assets/default-avatar.png'"
                  [alt]="conversation.otherUser.name || 'Utilisateur'"
                  class="w-14 h-14 rounded-full object-cover border-2 border-gray-200"
                />
              </div>

              <!-- Infos conversation -->
              <div class="ml-4 flex-1">
                <div class="flex justify-between mb-1">
                  <h3 class="font-semibold text-gray-900 group-hover:text-conexus-green transition-colors" 
                      [class.text-conexus-green]="selectedConversation?.otherUser?.id === conversation.otherUser.id">
                    {{ conversation.otherUser.name || 'Utilisateur inconnu' }} 
                  </h3>
                  <span class="text-sm text-gray-500">
                    {{ conversation.updatedAt | date: 'short' }}
                  </span>
                </div>

                <p class="text-gray-600 text-sm line-clamp-1">
                  {{ conversation.content || 'Aucun message' }}
                </p>
              </div>
            </div>
          </div>
        }
      }
    </div>
  </div>

  <!-- Section conversation en entier -->
  @if (selectedConversation) {
    <div class="md:flex-1 flex flex-col h-full my-10 md:max-w-none">
      
      <!-- Header de la conversation -->
      <div class="flex items-center p-4 bg-white border-b border-gray-200 rounded-t-xl shadow-sm">
        <img
          [src]="selectedConversation.otherUser?.profilePicture || 'assets/default-avatar.png'"
          [alt]="selectedConversation.otherUser?.name || 'Utilisateur'"
          class="w-12 h-12 rounded-full object-cover border-2 border-gray-200"
        />
        <div class="ml-3">
          <h2 class="font-semibold text-lg text-gray-900">
            {{ selectedConversation.otherUser?.name || 'Utilisateur inconnu' }}
          </h2>
          <p class="text-sm text-gray-500">En ligne</p>
        </div>
        
        <!-- Bouton fermer (optionnel sur mobile) -->
        <button 
          class="ml-auto md:hidden p-2 hover:bg-gray-100 rounded-full transition-colors"
          (click)="closeConversation()">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Zone des messages -->
      <div class="flex-1 overflow-y-auto p-4 bg-gray-50 space-y-2 md:max-h-[calc(100vh-300px)]" id="messagesContainer">
        
        <!-- Messages du chat -->
        @for (message of messages; track $index) {
          <!-- Message reçu (de l'autre utilisateur) -->
          @if (message.senderId !== message.currentUser.id) {
            <div class="flex items-start space-x-3 mb-4">
              <img 
                [src]="message.otherUser.profilePicture || 'assets/default-avatar.png'" 
                [alt]="message.otherUser.name || 'Utilisateur'"
                class="w-10 h-10 rounded-full object-cover flex-shrink-0"
              />
              <div class="bg-white p-3 rounded-lg shadow-sm max-w-xs lg:max-w-md">
                <p class="text-gray-800">{{ message.content }}</p>
                <span class="text-xs text-gray-500 mt-1 block">
                  {{ message.createdAt | date: 'short' }}
                </span>
              </div>
            </div>
          }
          
          <!-- Message envoyé (de l'utilisateur actuel) -->
          @else {
            <div class="flex items-start space-x-3 justify-end mb-4">
              <div class="bg-conexus-green text-gray-800 p-3 rounded-lg shadow-sm max-w-xs lg:max-w-md">
                <p>{{ message.content }}</p>
                <span class="text-xs text-gray-800 opacity-80 mt-1 block">
                  {{ message.createdAt | date: 'short' }}
                </span>
              </div>
              <img 
                [src]="message.currentUser.profilePicture || 'assets/default-avatar.png'"
                [alt]="message.currentUser.name || 'Moi'"
                class="w-10 h-10 rounded-full object-cover flex-shrink-0"
              />
            </div>
          }
        }
        
        <!-- Message si aucun message -->
        @if (messages.length === 0 && !isLoading) {
          <div class="text-center text-gray-500 py-8">
            <p>Aucun message dans cette conversation</p>
          </div>
        }
        
        <!-- Loading des messages -->
        @if (isLoading) {
          <div class="text-center text-gray-500 py-8">
            <p>Chargement des messages...</p>
          </div>
        }
      </div>

      <!-- Zone d'envoi de message -->
      <div class="p-4 bg-white border-t border-gray-200 rounded-b-xl shadow-sm">
        <form class="flex gap-3 items-center">
          <input
            class="flex-1 px-4 py-3 border border-gray-300 rounded-full shadow-sm transition duration-200 ease-in-out focus:ring-2 focus:ring-conexus-green focus:border-transparent bg-gray-50 focus:bg-white"
            placeholder="Tapez votre message..."
            type="text"
            formControlName="content"
          />
          <button 
            type="submit" 
            [disabled]="isLoading || messageForm.invalid"
            class="bg-conexus-green text-white px-6 py-3 rounded-full hover:bg-green-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center min-w-[100px]"
          >
            <span [class.hidden]="isLoading">Envoyer</span>
            <div [class.hidden]="!isLoading" class="flex space-x-1">
              <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
              <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
          </button>
        </form>
      </div>
    </div>
  }
  
  <!-- Message quand aucune conversation sélectionnée -->
  @else {
    <div class="md:flex-1 flex items-center justify-center my-10">
      <div class="text-center text-gray-500">
        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
        <p class="text-lg">Sélectionnez une conversation pour commencer</p>
      </div>
    </div>
  }
</div>

